# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in the `gql/` directory.

## Overview

The `gql/` package is a GraphQL schema and resolver generator for `go-crud`. It automatically creates GraphQL schemas, resolvers, and gqlgen configuration from CRUD controller metadata, enabling instant GraphQL APIs with Relay-style pagination, filtering, and mutations.

## Architecture

### Core Components

1. **[cmd/graphqlgen](cmd/graphqlgen/main.go:1)** - CLI tool for generating GraphQL assets
   - Reads metadata from JSON files, schema packages, or the in-memory registry
   - Filters entities with `--include`/`--exclude` globs
   - Customizes scalar mappings via `--type-mapping`
   - Optionally invokes gqlgen after generation

2. **[internal/generator](internal/generator/generator.go:1)** - Generation orchestrator
   - Loads metadata from multiple sources
   - Applies include/exclude filters
   - Formats metadata into intermediate document
   - Renders templates via renderer
   - Writes files with diff-aware writer
   - Optionally runs gqlgen

3. **[internal/metadata](internal/metadata/loader.go:1)** - Metadata loaders
   - `FromFile()` - Load from JSON file
   - `FromSchemaPackage()` - Import package and read registry
   - `FromRegistry()` - Read in-memory schema registry
   - Handles both `router.SchemaMetadata` and `crud.SchemaEntry` formats

4. **[internal/formatter](internal/formatter/formatter.go:1)** - GraphQL schema formatter
   - Converts CRUD metadata to GraphQL types
   - Maps OpenAPI types to GraphQL scalars
   - Generates Relay connections (`XConnection`/`XEdge`)
   - Creates mutation input/payload types
   - Applies type mappings and custom scalars

5. **[internal/templates](internal/templates/templates.go:1)** - Template system
   - Embedded templates using Django/pongo2 syntax
   - `schema.graphql.tmpl` - GraphQL SDL
   - `gqlgen.yml.tmpl` - gqlgen configuration
   - `models_gen.go.tmpl` - Go model types
   - `resolver_gen.go.tmpl` - Generated resolvers
   - Custom filters for GraphQL naming conventions

6. **[internal/writer](internal/writer/writer.go:1)** - File writer
   - `WriteGenerated()` - Overwrites with header `Code generated by graphqlgen. DO NOT EDIT.`
   - `WriteCustomOnce()` - Writes only if file doesn't exist (unless `--force`)
   - Diff-aware: skips writes if content unchanged
   - Applies goimports/gofmt to `.go` files

7. **[internal/overlay](internal/overlay/overlay.go:1)** - Schema overlay system
   - Enriches metadata with custom scalars, enums, inputs, operations
   - Supports JSON/YAML overlay files via `--overlay-file`
   - Merges overlay definitions into generated schema

8. **[internal/gqlgen](internal/gqlgen/gqlgen.go:1)** - gqlgen integration
   - Invokes gqlgen programmatically after file generation
   - Controlled via `--run-gqlgen` and `--skip-gqlgen` flags

## Development Commands

### Running the Generator

```bash
# Generate from metadata file
go run ./gql/cmd/graphqlgen --metadata-file ./gql/examples/minimal/metadata.json --out graph --config gqlgen.yml

# Generate from schema package (imports package first)
go run ./gql/cmd/graphqlgen --schema-package ./internal/yourapp --out graph

# Generate with filters
go run ./gql/cmd/graphqlgen --include "User,Post" --exclude "Internal*"

# Custom scalar mappings
go run ./gql/cmd/graphqlgen --type-mapping string:uuid=UUID --type-mapping time.Time=Time

# Dry run to preview
go run ./gql/cmd/graphqlgen --dry-run

# Generate and run gqlgen
go run ./gql/cmd/graphqlgen --run-gqlgen

# Force overwrite custom files
go run ./gql/cmd/graphqlgen --force

# Emit dataloader scaffold
go run ./gql/cmd/graphqlgen --emit-dataloader

# Custom templates
go run ./gql/cmd/graphqlgen --template-dir ./custom-templates

# Policy hook for scope guards
go run ./gql/cmd/graphqlgen --policy-hook mypkg.CheckScope

# Omit fields from mutations
go run ./gql/cmd/graphqlgen --omit-mutation-field password --omit-mutation-field User.ssn

# Schema overlay
go run ./gql/cmd/graphqlgen --overlay-file ./overlay.json
```

### Testing

```bash
# Run all tests
go test -v ./gql/...

# Run specific test
go test -v ./gql/internal/formatter -run TestFormat

# Run generator tests
go test -v ./gql/cmd/graphqlgen -run TestRun
```

### Examples

```bash
# Minimal example
cd gql/examples/minimal
cat metadata.json
ls -R output/

# Relationships example
cd gql/examples/relationships
ls -R output/
```

## CLI Flags Reference

### Required (one of)
- `--metadata-file` - Path to JSON file with `router.SchemaMetadata`
- `--schema-package` - Package to import before reading registry
- (none) - Reads from in-memory registry

### Output Paths
- `--out` - Output base directory (default: `graph`)
- `--config` - Path to gqlgen.yml (default: `gqlgen.yml`)

### Filtering
- `--include` - Entity name glob patterns (repeatable)
- `--exclude` - Entity name glob patterns (repeatable)

### Customization
- `--type-mapping` - Scalar overrides: `type[:format[:goType]]=Scalar`
  - Examples: `string:uuid=UUID`, `time.Time=Time`, `*time.Time=Time`
- `--omit-mutation-field` - Field name or `Entity.field` to omit from mutations
- `--policy-hook` - Scope guard function like `mypkg.CheckScope`
- `--overlay-file` - JSON/YAML overlay file for custom scalars/enums/inputs

### Code Generation
- `--emit-dataloader` - Generate dataloader scaffold
- `--template-dir` - Custom template directory (overrides embedded)
- `--goimports` - Apply goimports (default: true)
- `--run-gqlgen` - Run gqlgen after generation (default: false)
- `--skip-gqlgen` - Skip gqlgen even if `--run-gqlgen` is set

### Control Flow
- `--dry-run` - Preview without writing files
- `--force` - Overwrite custom stub files (`resolver_custom.go`, etc.)

## Output Layout

Default output structure:

```
graph/
├── schema.graphql          # Generated GraphQL SDL
├── model/
│   ├── models_gen.go       # Generated Go types
│   └── models_custom.go    # Custom stub (write-once)
├── resolvers/
│   ├── resolver_gen.go     # Generated resolvers
│   └── resolver_custom.go  # Custom stub (write-once)
└── dataloader/             # Optional with --emit-dataloader
    └── dataloader_gen.go   # Generated dataloader scaffold
gqlgen.yml                  # Generated gqlgen config
```

### File Lifecycle

- **`_gen.go` files** - Regenerated on every run, contain `Code generated by graphqlgen. DO NOT EDIT.` header
- **`_custom.go` files** - Written once, never overwritten (unless `--force`)
- **Diff-aware writes** - Skips file write if content unchanged
- Keep `_custom` files under version control

## GraphQL Schema Features

### Queries

For each entity:
- `{entity}(id: ID!): {Entity}` - Get by ID
- `{entities}(filter: {Entity}Filter, orderBy: [OrderBy], first: Int, after: String): {Entity}Connection` - List with Relay pagination

### Mutations

For each entity:
- `create{Entity}(input: Create{Entity}Input!): Create{Entity}Payload`
- `update{Entity}(id: ID!, input: Update{Entity}Input!): Update{Entity}Payload`
- `delete{Entity}(id: ID!): Delete{Entity}Payload`

### Relay Connections

All list queries return Relay-style connections:

```graphql
type UserConnection {
  edges: [UserEdge!]!
  pageInfo: PageInfo!
  total: Int!
}

type UserEdge {
  node: User!
  cursor: String!
}

type PageInfo {
  hasNextPage: Boolean!
  hasPreviousPage: Boolean!
  startCursor: String
  endCursor: String
}
```

### Filters

Generated for each entity based on field types:

```graphql
input UserFilter {
  name: StringFilter
  age: IntFilter
  email: StringFilter
  createdAt: TimeFilter
}

input StringFilter {
  eq: String
  ne: String
  like: String
  ilike: String
  in: [String!]
}
```

Operators map to CRUD query operators.

### Type Mappings

Default mappings:
- `string` → `String`
- `integer` → `Int`
- `number` → `Float`
- `boolean` → `Boolean`
- `string:uuid` → `ID`
- `string:date-time` → `Time`

Override with `--type-mapping`:
```bash
--type-mapping "string:uuid=UUID"
--type-mapping "time.Time=Time"
--type-mapping "*time.Time=Time"
```

## Integration Patterns

### Using `//go:generate`

Add to your resolver package:

```go
package resolvers

//go:generate go run ../../gql/cmd/graphqlgen --schema-package ./internal/api --out ../graph --config ../gqlgen.yml
```

Then run:
```bash
go generate ./...
```

### Makefile Target

```makefile
.PHONY: graphql
graphql:
	go run ./gql/cmd/graphqlgen --out graph --config gqlgen.yml --run-gqlgen

.PHONY: graphql-dry
graphql-dry:
	go run ./gql/cmd/graphqlgen --dry-run
```

### CI/CD Pipeline

```bash
# Generate and verify no changes
go run ./gql/cmd/graphqlgen
git diff --exit-code graph/ gqlgen.yml
```

## Custom Resolver Implementation

Edit `resolver_custom.go` to implement custom logic:

```go
package resolvers

import (
	"context"
	"github.com/goliatone/go-crud"
)

// ScopeGuard returns actor context and scope filter for all resolvers
func (r *Resolver) ScopeGuard(ctx context.Context, op crud.CrudOperation) (crud.ActorContext, crud.ScopeFilter, error) {
	// Extract from context, auth middleware, etc.
	actor := crud.ActorContext{
		ActorID:  "user-123",
		TenantID: "tenant-456",
	}

	scope := crud.ScopeFilter{}
	scope.AddColumnFilter("tenant_id", "=", actor.TenantID)

	return actor, scope, nil
}

// Custom resolver for specific field
func (r *queryResolver) User(ctx context.Context, id string) (*model.User, error) {
	// Custom implementation
}
```

## Template Customization

Override templates by creating files in a custom directory:

```
custom-templates/
├── schema.graphql.tmpl
├── resolver_gen.go.tmpl
└── models_gen.go.tmpl
```

Then use:
```bash
go run ./gql/cmd/graphqlgen --template-dir ./custom-templates
```

Templates use Django/pongo2 syntax:
- `{% for entity in entities %}...{% endfor %}`
- `{{ entity.Name }}`, `{{ field.Type }}`
- Filters: `{{ name|camel }}`, `{{ name|pascal }}`

## Schema Overlay

Enrich generated schema with custom types:

```json
{
  "scalars": [
    {"name": "UUID", "goType": "github.com/google/uuid.UUID"}
  ],
  "enums": [
    {
      "name": "Role",
      "values": ["ADMIN", "USER", "GUEST"]
    }
  ],
  "inputs": [
    {
      "name": "CustomFilter",
      "fields": [
        {"name": "search", "type": "String"}
      ]
    }
  ],
  "operations": [
    {
      "type": "query",
      "name": "healthCheck",
      "returnType": "Boolean!",
      "description": "Health check endpoint"
    }
  ]
}
```

Use with:
```bash
go run ./gql/cmd/graphqlgen --overlay-file overlay.json
```

## Troubleshooting

### Package Not Found

If `--schema-package` fails:
```bash
# Ensure package is importable
go list ./internal/yourapp

# Use absolute import path
--schema-package github.com/yourorg/yourapp/internal/api
```

### No Schemas Found

If registry is empty:
```bash
# Ensure controllers are registered (imported)
# Check that RegisterRoutes or NewController was called

# Use --metadata-file as fallback
--metadata-file ./schemas.json
```

### Type Mapping Not Applied

Check mapping format:
```bash
# Correct
--type-mapping "string:uuid=UUID"

# Incorrect
--type-mapping "uuid=UUID"  # Missing type prefix
```

### gqlgen Errors

If gqlgen fails after generation:
```bash
# Run gqlgen manually to see full error
go run github.com/99designs/gqlgen generate

# Skip gqlgen during development
--skip-gqlgen
```

## Best Practices

1. **Version Control**
   - Commit `_custom.go` files
   - Add `_gen.go` to `.gitignore` or commit for reproducibility
   - Commit `schema.graphql` and `gqlgen.yml`

2. **Metadata Sources**
   - Use `--schema-package` for live schema registry
   - Use `--metadata-file` for CI/CD reproducibility
   - Snapshot metadata to JSON for version control

3. **Regeneration**
   - Rerun generator after changing CRUD metadata
   - Use `--dry-run` to preview changes
   - Review diffs before committing

4. **Custom Logic**
   - Keep custom code in `_custom.go` files
   - Override specific resolvers as needed
   - Implement `ScopeGuard()` for multi-tenancy

5. **Testing**
   - Test generated schema with GraphQL clients
   - Verify Relay pagination works correctly
   - Test filters and ordering
   - Validate scope guard enforcement

## Related Documentation

- Main CRUD package: [../CLAUDE.md](../CLAUDE.md)
- GraphQL README: [README.md](README.md)
- Examples: [examples/minimal/](examples/minimal/), [examples/relationships/](examples/relationships/)
